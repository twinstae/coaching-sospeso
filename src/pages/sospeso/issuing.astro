---
import { SospesoIssuingForm } from "@/components/SospesoIssuingForm.tsx";
import Layout from "@/layouts/Layout.astro";

const session = Astro.locals.session;

if (!session) {
  // TODO! 로그인 페이지로 리다이렉트 시키기
  //  https://docs.astro.build/en/guides/routing/#dynamic-redirects
  return Astro.redirect("/auth/login");
}
---

<Layout title="소스페소 발행하기">
  <SospesoIssuingForm client:load userNickname={session.name} />
</Layout>

<script>
  import { sospesoIssuingEventBus } from "@/components/SospesoIssuingForm";
  import { navigate } from "@/routing/navigate";
  import { actions } from "astro:actions";

  const session = { id: crypto.randomUUID() }; // TODO! user 로그인 세션 구현하면 넣어줘야 함!

  sospesoIssuingEventBus.on(window.document.body, (command) => {
    actions
      .issueSospeso({ ...command, issuedAt: new Date(), issuerId: session.id })
      .then((result) => {
        if (result.error) {
          return console.error(result.error);
        }

        navigate("소스페소-상세", { sospesoId: command.sospesoId });
      });
  });
</script>
