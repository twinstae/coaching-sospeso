---
import { SospesoConsumingForm } from '@/components/SospesoConsumingForm.tsx';
import Layout from '@/layouts/Layout.astro';
---

<Layout title="소스페소 발행하기">
  <SospesoConsumingForm client:load />
</Layout>

<script>
  import { sospesoConsumingEventBus } from '@/components/SospesoConsumingForm.tsx';
  import invariant from '@/invariant.ts';
  import { navigate } from '@/routing/navigate.ts';
  import { actions } from 'astro:actions';

  invariant(sospesoId, '404 NOT FOUND');

  sospesoConsumingEventBus.on(window.document.body, (command) => {
    const consumerId = new URLSearchParams(window.location.search).get(
      'consumerId'
    );

    invariant(consumerId, '사용자의 id가 없습니다!');

    actions
      .consumeSospeso({
        ...command,
        sospesoId,
        consumerId,
      })
      .then(() => {
        navigate('소스페소-상세', { sospesoId });
      });
  });
</script>
